<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        /* Top Bar Styles */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .known-words-counter {
            font-size: 16px;
            font-weight: bold;
        }

        .top-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-button {
            background: #34495e;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-button:hover {
            background: #435d78;
        }

        /* Container Styles */
        .container {
            max-width: 1000px;
            margin: 60px auto 0;
            padding: 20px;
        }

        /* Home Page Styles */
        .home-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
        }

        .home-title {
            color: #2c3e50;
            margin-bottom: 40px;
            font-size: 2.5em;
        }

        .button-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 1fr;
            margin: 0 auto;
            max-width: 600px;
            width: 90%;
        }

        .home-button {
            padding: 30px 20px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #2c3e50;
            color: white;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .home-button:hover {
            transform: translateY(-2px);
            background: #34495e;
        }

        .home-button:active {
            transform: translateY(0);
        }

        /* Create Text Page Styles */
        .create-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #textInput {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
        }

        .button-container {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .save-button {
            background: #4CAF50;
            color: white;
        }

        .save-button:hover {
            background: #45a049;
        }

        .cancel-button {
            background: #e74c3c;
            color: white;
        }

        .cancel-button:hover {
            background: #c0392b;
        }

        /* Read Page Styles */
        .text-display-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #textDisplay {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
        }

        #textDisplay span {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: filter 0.2s;
        }

        #textDisplay span:hover {
            filter: brightness(0.9);
        }

        /* Word knowledge levels */
        .word-new { background-color: #a8d5ff; }
        .word-level-1 { background-color: #fff176; }
        .word-level-2 { background-color: #ffd54f; }
        .word-level-3 { background-color: #ffb300; }
        .word-level-4 { background-color: #c5e1a5; }
        .word-level-5 { background-color: #81c784; }

        /* Rating Overlay Styles */
        .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000; /* Higher z-index */
}

        .rating-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .selected-word {
            font-size: 24px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-weight: bold;
        }

        .definition-section {
            margin: 15px 0;
        }

        .suggested-translation {
            margin-bottom: 10px;
            font-style: italic;
        }

        .custom-definition {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }

        .rating-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .rating-button {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
            color: #333;
        }

        .rating-button:hover {
            transform: scale(1.1);
        }

        .rating-button.level-1 { background-color: #fff176; }
        .rating-button.level-2 { background-color: #ffd54f; }
        .rating-button.level-3 { background-color: #ffb300; }
        .rating-button.level-4 { background-color: #c5e1a5; }
        .rating-button.level-5 { background-color: #81c784; }

        .mark-new-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .mark-new-button:hover {
            background: #45a049;
        }

        /* Sentence Mode Styles */
        .sentence-mode-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000; /* Lower z-index */
}

        .sentence-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Vocabulary Overview Styles */
        .vocabulary-overview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .overview-title {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input, .level-filter {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-input {
            flex: 1;
        }

        .vocabulary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .vocabulary-table th,
        .vocabulary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .vocabulary-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .edit-definition {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-definition:hover {
            background: #2980b9;
        }



    /* Sentence Mode Styles */
   

    /* File input and page visibility styles */
    

        /* File input and page visibility styles */
        .file-input {
            display: none;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
        

.translation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.toggle-translation-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 5px 10px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.toggle-translation-btn:hover {
    background-color: #e0e0e0;
}

.toggle-translation-btn.hidden .toggle-icon {
    opacity: 0.5;
}

.sentence-content {
    font-size: 20px;
    line-height: 1.6;
    min-height: 50px;
}

.sentence-content span {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    margin: 0 2px;
}

.sentence-translation {
    font-size: 18px;
    color: #666;
    margin: 10px 0;
    font-style: italic;
    padding: 10px;
}

.translation-section.hidden .sentence-translation {
    display: none;
}

.sentence-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.sentence-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.nav-arrow {
    background: #2c3e50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-arrow:hover {
    background: #34495e;
}

.nav-arrow:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Sentence highlighting in text */
.sentence-highlight {
    background-color: rgba(231, 76, 60, 0.2);
    border-radius: 4px;
}    
    </style>
</head>
<body>
    <!-- Top Bar -->
    <!-- Top Bar -->
<div class="top-bar">
    <div class="known-words-counter">Known Words: <span id="knownWordsCount">0</span></div>
    <div class="top-buttons">
        <button class="nav-button sentence-mode-toggle" onclick="toggleSentenceMode()">Sentence Mode</button>
        <button class="nav-button" onclick="showPage('home')">Home</button>
    </div>
</div>

    <!-- Home Page -->
    <div id="homePage" class="page">
        <div class="home-container">
            <h1 class="home-title">Language Learning App</h1>
            <div class="button-grid">
            <input type="file" id="loadTextInput" class="file-input" accept=".txt">
                <input type="file" id="loadVocabInput" class="file-input" accept=".json">
                
                <button class="home-button" onclick="document.getElementById('loadTextInput').click()">
                    Load Text
                </button>
                <button class="home-button" onclick="showPage('create')">
                    Create Text
                </button>
                <button class="home-button" onclick="saveVocabulary()">
                    Save Vocabulary
                </button>
                <button class="home-button" onclick="document.getElementById('loadVocabInput').click()">
                    Load Vocabulary
                </button>
                <button class="home-button" onclick="showVocabularyOverview()">
                    View Vocabulary List
                </button>
            </div>
        </div>
    </div>

    <!-- Create Text Page -->
    <div id="createPage" class="page">
        <div class="container">
            <div class="create-container">
                <textarea id="textInput" placeholder="Write or paste your text here..."></textarea>
                <div class="button-container">
                    <button class="action-button save-button" onclick="saveAndRead()">Save & Continue to Reading</button>
                    <button class="action-button cancel-button" onclick="showPage('home')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Read Page -->
    <div id="readPage" class="page">
        <div class="container">
            <div class="text-display-container">
                <div id="textDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Overview Page -->
    <div id="vocabularyOverviewPage" class="page">
        <div class="container">
            <div class="vocabulary-overview">
                <h2 class="overview-title">Vocabulary Overview</h2>
                <div class="filter-section">
                    <input type="text" id="vocabularySearch" placeholder="Search words..." class="search-input">
                    <select id="levelFilter" class="level-filter">
                        <option value="all">All Levels</option>
                        <option value="0">New Words</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                    </select>
                </div>
                <table id="vocabularyTable" class="vocabulary-table">
                    <thead>
                        <tr>
                            <th>Spanish Word</th>
                            <th>Translation</th>
                            <th>Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Rating Overlay -->
    <div id="ratingOverlay" class="overlay">
        <div class="rating-box">
            <div class="selected-word"></div>
            <div class="definition-section">
                <div class="suggested-translation">Suggested: <span class="word-translation">Translating...</span></div>
                <input type="text" class="custom-definition" placeholder="Enter custom definition (optional)">
            </div>
            <div>Rate how well you know this word:</div>
            <div class="rating-buttons">
                <button class="rating-button level-1" onclick="rateWord(1)">1</button>
                <button class="rating-button level-2" onclick="rateWord(2)">2</button>
                <button class="rating-button level-3" onclick="rateWord(3)">3</button>
                <button class="rating-button level-4" onclick="rateWord(4)">4</button>
                <button class="rating-button level-5" onclick="rateWord(5)">5</button>
            </div>
            <button class="mark-new-button" onclick="markAsNew()">Mark as New</button>
        </div>
    </div>

    <!-- Sentence Mode Overlay -->
    <div id="sentenceModeOverlay" class="sentence-mode-overlay">
        <div class="sentence-box">
            <button class="sentence-close" onclick="closeSentenceMode()">×</button>
            
            <!-- Original sentence with clickable words -->
            <div class="sentence-section">
                <h3>Spanish</h3>
                <div class="sentence-content"></div>
            </div>
            
            <!-- Translation section with toggle -->
            <div class="sentence-section translation-section">
                <div class="translation-header">
                    <h3>English</h3>
                    <button class="toggle-translation-btn" onclick="toggleTranslation()">
                        <span class="toggle-icon">👁️</span>
                    </button>
                </div>
                <div class="sentence-translation"></div>
            </div>

            <!-- Word rating section (initially hidden) -->
            <div id="overlayWordRating" class="word-rating-section" style="display: none;">
                <div class="rating-word-container">
                    <div class="selected-word"></div>
                    <div class="word-translation"></div>
                </div>
                <div>Rate how well you know this word:</div>
                <div class="rating-buttons">
                    <button class="rating-button level-1" onclick="rateOverlayWord(1)">1</button>
                    <button class="rating-button level-2" onclick="rateOverlayWord(2)">2</button>
                    <button class="rating-button level-3" onclick="rateOverlayWord(3)">3</button>
                    <button class="rating-button level-4" onclick="rateOverlayWord(4)">4</button>
                    <button class="rating-button level-5" onclick="rateOverlayWord(5)">5</button>
                </div>
                <button class="mark-new-button" onclick="markOverlayWordAsNew()">Mark as New</button>
            </div>

            <div class="sentence-navigation">
                <button class="nav-arrow" onclick="navigateSentence(-1)">
                    ← Previous
                </button>
                <span id="sentenceCounter"></span>
                <button class="nav-arrow" onclick="navigateSentence(1)">
                    Next →
                </button>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div id="statusMessage" class="status-message"></div>

    <script>
        // Global variables
        let vocabulary = {};
        let currentWord = null;
        let currentElement = null;
        let sentenceMode = false;
        let sentences = [];
        let currentSentenceIndex = 0;
        let lastClickedSentenceIndex = 0;
        let currentOverlayWord = null;
        let currentOverlayElement = null;
        let translationVisible = false;

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadVocabulary();
            showPage('home');

            const draftText = localStorage.getItem('draftText');
            if (draftText) {
                document.getElementById('textInput').value = draftText;
            }
        });

        // Status message handling
        function showStatus(message, duration = 3000) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, duration);
        }

        // Translation functions
        async function translateWord(word) {
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=es|en`);
                const data = await response.json();
                return data.responseData.translatedText;
            } catch (error) {
                console.error('Translation error:', error);
                return 'Translation failed';
            }
        }

        async function translateSentence(sentence) {
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(sentence)}&langpair=es|en`);
                const data = await response.json();
                return data.responseData.translatedText;
            } catch (error) {
                console.error('Translation error:', error);
                return 'Translation failed';
            }
        }

        // Vocabulary management
        function loadVocabulary() {
            const savedVocab = localStorage.getItem('vocabulary');
            if (savedVocab) {
                vocabulary = JSON.parse(savedVocab);
                updateKnownWordsCount();
            }
        }

        function saveVocabulary() {
            try {
                localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                
                const blob = new Blob([JSON.stringify(vocabulary, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vocabulary.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Progress saved!');
            } catch (err) {
                showStatus('Error saving progress');
                console.error('Error:', err);
            }
        }

        function updateKnownWordsCount() {
            const knownWords = Object.values(vocabulary)
                .filter(word => word.level >= 4).length;
            document.getElementById('knownWordsCount').textContent = knownWords;
        }

        // Text handling
        function processText(text) {
            sentences = text.match(/[^.!?]+[.!?]+/g) || [];
            sentences = sentences.map(s => s.trim());
            
            const display = document.getElementById('textDisplay');
            
            display.innerHTML = sentences.map((sentence, idx) => {
                const words = sentence.match(/\S+/g) || [];
                
                const processedWords = words.map(word => {
                    const originalWord = word;
                    const cleanWord = word.replace(/[^a-záéíóúüñÁÉÍÓÚÜÑA-Z\s]/g, '');
                    const vocabEntry = vocabulary[cleanWord.toLowerCase()];
                    const levelClass = vocabEntry ? 
                        (vocabEntry.level === 0 ? 'word-new' : `word-level-${vocabEntry.level}`) : '';
                    
                    return `<span class="${levelClass}" 
                        data-sentence-index="${idx}"
                        onclick="handleTextClick(this, '${encodeURIComponent(cleanWord)}')">${originalWord}</span>`;
                }).join(' ');
                
                return `<span class="sentence" data-sentence-index="${idx}">${processedWords}</span>`;
            }).join(' ');
        }

        // Show vocabulary overview
        function showVocabularyOverview() {
            showPage('vocabularyOverview');
            updateVocabularyTable();
        }

        function updateVocabularyTable() {
            const tbody = document.querySelector('#vocabularyTable tbody');
            const searchTerm = document.getElementById('vocabularySearch').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value;
            
            tbody.innerHTML = '';
            
            Object.entries(vocabulary)
                .filter(([key, entry]) => {
                    const matchesSearch = entry.word.toLowerCase().includes(searchTerm) ||
                        (entry.definition || '').toLowerCase().includes(searchTerm);
                    const matchesLevel = levelFilter === 'all' || entry.level.toString() === levelFilter;
                    return matchesSearch && matchesLevel;
                })
                .sort((a, b) => a[1].word.localeCompare(b[1].word))
                .forEach(([key, entry]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.word}</td>
                        <td>${entry.definition || 'No definition'}</td>
                        <td>${entry.level}</td>
                        <td>
                            <button class="edit-definition" onclick="editDefinition('${entry.word}')">
                                Edit
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }

        function editDefinition(word) {
            currentWord = word;
            const entry = vocabulary[word.toLowerCase()];
            
            const overlay = document.getElementById('ratingOverlay');
            overlay.querySelector('.selected-word').textContent = word;
            overlay.querySelector('.word-translation').textContent = entry.definition || 'No definition';
            overlay.querySelector('.custom-definition').value = entry.definition || '';
            
            overlay.style.display = 'block';
        }

        // Word and sentence handling
       function handleTextClick(element, encodedWord) {
    const sentenceIndex = parseInt(element.closest('.sentence').dataset.sentenceIndex);
    lastClickedSentenceIndex = sentenceIndex;
    
    if (sentenceMode) {
        showSentenceOverlay(sentenceIndex);
    } else {
        handleWordClick(element, encodedWord);
    }
}

        async function handleWordClick(element, encodedWord) {
            if (!encodedWord) return;
            
            const word = decodeURIComponent(encodedWord);
            currentWord = word;
            currentElement = element;
            
            const overlay = document.getElementById('ratingOverlay');
            const wordEntry = vocabulary[word.toLowerCase()];
            
            overlay.querySelector('.selected-word').textContent = word;
            
            if (wordEntry && wordEntry.definition) {
                overlay.querySelector('.word-translation').textContent = wordEntry.definition;
                overlay.querySelector('.custom-definition').value = wordEntry.definition;
            } else {
                overlay.querySelector('.word-translation').textContent = 'Translating...';
                overlay.querySelector('.custom-definition').value = '';
                const translation = await translateWord(word);
                overlay.querySelector('.word-translation').textContent = translation;
            }
            
            overlay.style.display = 'block';
        }

        // Rating functions
        function updateWordRating(word, element, level) {
            element.classList.remove('word-new', 'word-level-1', 'word-level-2', 
                'word-level-3', 'word-level-4', 'word-level-5');
            
            element.classList.add(level === 0 ? 'word-new' : `word-level-${level}`);
            
            const wordKey = word.toLowerCase();
            const customDefinition = document.querySelector('.custom-definition').value;
            const suggestedDefinition = document.querySelector('.word-translation').textContent;
            
            vocabulary[wordKey] = {
                word: word,
                level: level,
                timestamp: new Date().toISOString(),
                definition: customDefinition || suggestedDefinition
            };

            const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const wordRegex = new RegExp(`^${escapedWord}$`, 'i');
            
            document.querySelectorAll('#textDisplay span, .sentence-content span').forEach(span => {
                const spanWord = span.textContent.replace(/[^a-záéíóúüñÁÉÍÓÚÜÑA-Z\s]/g, '');
                if (wordRegex.test(spanWord)) {
                    span.className = level === 0 ? 'word-new' : `word-level-${level}`;
                }
            });

            updateKnownWordsCount();
            saveToLocalStorage();
        }

        function closeRating() {
            document.getElementById('ratingOverlay').style.display = 'none';
            currentWord = null;
            currentElement = null;
        }

        function rateWord(level) {
            if (currentElement && currentWord) {
                updateWordRating(currentWord, currentElement, level);
            }
            closeRating();
        }

        function markAsNew() {
            if (currentElement && currentWord) {
                updateWordRating(currentWord, currentElement, 0);
            }
            closeRating();
        }

        // Sentence mode functions remain the same
        // ... (keep all your existing sentence mode functions) ...

        // Event listeners
        document.getElementById('vocabularySearch').addEventListener('input', updateVocabularyTable);
        document.getElementById('levelFilter').addEventListener('change', updateVocabularyTable);

      document.getElementById('loadTextInput').addEventListener('change', function(e) {
    const file = e.target.files[0]; // Get only the first file
    if (!file) {
        showStatus('No file selected');
        return;
    }
    
    if (!file.name.endsWith('.txt')) {
        showStatus('Please select a text file');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const text = e.target.result;
            localStorage.setItem('currentText', text);
            processText(text);
            showPage('read');
        } catch (err) {
            showStatus('Error processing file');
            console.error('Error:', err);
        }
    };

    reader.onerror = function() {
        showStatus('Error reading file');
    };

    reader.readAsText(file);
    this.value = ''; // Reset file input
});

        document.getElementById('loadVocabInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        vocabulary = JSON.parse(e.target.result);
                        localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                        updateKnownWordsCount();
                        showStatus('Vocabulary loaded successfully!');
                    } catch (err) {
                        showStatus('Error loading vocabulary file');
                        console.error('Error parsing vocabulary:', err);
                    }
                };
                reader.readAsText(file);
            }
            this.value = '';
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
    if (document.getElementById('ratingOverlay').style.display === 'block') {
        if (e.key >= '1' && e.key <= '5') {
            rateWord(parseInt(e.key));
        } else if (e.key === 'n') {
            markAsNew();
        } else if (e.key === 'Escape') {
            closeRating();
        }
    } else if (document.getElementById('sentenceModeOverlay').style.display === 'block') {
        if (e.key === 'ArrowLeft') {
            navigateSentence(-1);
        } else if (e.key === 'ArrowRight') {
            navigateSentence(1);
        } else if (e.key === 'Escape') {
            closeSentenceMode();
        } else if (e.key === 't') {
            toggleTranslation();
        }
    }
});

        // Sentence mode functions
        function toggleSentenceMode() {
            sentenceMode = !sentenceMode;
            const toggle = document.querySelector('.sentence-mode-toggle');
            toggle.classList.toggle('active');
            
            if (sentenceMode) {
                showSentenceOverlay(lastClickedSentenceIndex || 0);
            } else {
                closeSentenceMode();
            }
            
            showStatus(sentenceMode ? 'Sentence Mode Active' : 'Sentence Mode Disabled');
        }

       function toggleTranslation() {
    translationVisible = !translationVisible;
    const translationSection = document.querySelector('.translation-section');
    const toggleButton = document.querySelector('.toggle-translation-btn');
    
    if (translationVisible) {
        translationSection.classList.remove('hidden');
        toggleButton.classList.remove('hidden');
    } else {
        translationSection.classList.add('hidden');
    }
    // Don't hide the toggle button itself, only the translation section
}

        async function showSentenceOverlay(index) {
            currentSentenceIndex = index;
            const overlay = document.getElementById('sentenceModeOverlay');
            const sentence = sentences[index];
            
            // Highlight the sentence in the main text
            document.querySelectorAll('.sentence-highlight').forEach(el => {
                el.classList.remove('sentence-highlight');
            });
            document.querySelector(`.sentence[data-sentence-index="${index}"]`)
                .classList.add('sentence-highlight');
            
            // Process sentence for clickable words
            const words = sentence.match(/\S+/g) || [];
            const content = overlay.querySelector('.sentence-content');
            content.innerHTML = words.map(word => {
                const originalWord = word;
                const cleanWord = word.replace(/[^a-záéíóúüñÁÉÍÓÚÜÑA-Z\s]/g, '');
                const vocabEntry = vocabulary[cleanWord.toLowerCase()];
                const levelClass = vocabEntry ? 
                    (vocabEntry.level === 0 ? 'word-new' : `word-level-${vocabEntry.level}`) : '';
                
                return `<span class="${levelClass}" 
                    onclick="handleOverlayWordClick(this, '${encodeURIComponent(cleanWord)}')">${originalWord}</span>`;
            }).join(' ');
            
            // Get and display translation (initially hidden)
            const translationDiv = overlay.querySelector('.sentence-translation');
            const translationSection = document.querySelector('.translation-section');
            translationDiv.textContent = 'Translating...';
            const translation = await translateSentence(sentence);
            translationDiv.textContent = translation;
            
            // Ensure translation is hidden by default
           // Ensure translation is hidden by default but keep the toggle button visible
translationSection.classList.add('hidden');
document.querySelector('.toggle-translation-btn').classList.remove('hidden');
translationVisible = false;
            
            updateSentenceNavigation();
            overlay.style.display = 'block';
            
            // Hide word rating section initially
            document.getElementById('overlayWordRating').style.display = 'none';
        }

        async function handleOverlayWordClick(element, encodedWord) {
    const word = decodeURIComponent(encodedWord);
    handleWordClick(element, encodedWord);
}

        function updateSentenceNavigation() {
            const counter = document.getElementById('sentenceCounter');
            const prevButton = document.querySelector('.nav-arrow:first-child');
            const nextButton = document.querySelector('.nav-arrow:last-child');
            
            counter.textContent = `${currentSentenceIndex + 1} / ${sentences.length}`;
            prevButton.disabled = currentSentenceIndex === 0;
            nextButton.disabled = currentSentenceIndex === sentences.length - 1;
        }

        async function navigateSentence(direction) {
            const newIndex = currentSentenceIndex + direction;
            if (newIndex >= 0 && newIndex < sentences.length) {
                document.querySelector(`.sentence[data-sentence-index="${currentSentenceIndex}"]`)
                    .classList.remove('sentence-highlight');
                currentSentenceIndex = newIndex;
                await showSentenceOverlay(currentSentenceIndex);
            }
        }

       function closeSentenceMode() {
    document.getElementById('sentenceModeOverlay').style.display = 'none';
    document.querySelectorAll('.sentence-highlight').forEach(el => {
        el.classList.remove('sentence-highlight');
    });
    translationVisible = false;
    
    // Automatically disable sentence mode when closing
    sentenceMode = false;
    const toggle = document.querySelector('.sentence-mode-toggle');
    toggle.classList.remove('active');
}

        function rateOverlayWord(level) {
            if (currentOverlayElement && currentOverlayWord) {
                updateWordRating(currentOverlayWord, currentOverlayElement, level);
                document.getElementById('overlayWordRating').style.display = 'none';
            }
        }

        function markOverlayWordAsNew() {
            if (currentOverlayElement && currentOverlayWord) {
                updateWordRating(currentOverlayWord, currentOverlayElement, 0);
                document.getElementById('overlayWordRating').style.display = 'none';
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            } catch (err) {
                console.error('Error saving to localStorage:', err);
            }
        }

        // Auto-save draft every 30 seconds
        setInterval(() => {
            const text = document.getElementById('textInput').value;
            if (text.trim()) {
                localStorage.setItem('draftText', text);
            }
        }, 30000);

        // Save and read text
        function saveAndRead() {
            const text = document.getElementById('textInput').value;
            
            if (!text.trim()) {
                showStatus('Please enter some text before saving');
                return;
            }

            try {
                localStorage.setItem('currentText', text);
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'text.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                processText(text);
                showPage('read');
            } catch (err) {
                showStatus('Error saving text');
                console.error('Error:', err);
            }
        }

        // Overlay click handlers
        document.getElementById('ratingOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRating();
            }
        });

        document.getElementById('sentenceModeOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSentenceMode();
    }
});
    </script>
</body>
</html>